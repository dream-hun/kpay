name: Commit convention (Conventional Commits)

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
  push:
    tags-ignore:
      - '**'

permissions:
  contents: read
  pull-requests: read

jobs:
  conventional-commits:
    name: Validate PR title and commits
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || !github.event.pull_request.draft }}

    steps:
      - name: Validate Conventional Commits
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const allowedTypes = [
              'feat',
              'fix',
              'docs',
              'refactor',
              'perf',
              'test',
              'build',
              'ci',
              'chore',
              'style',
              'revert',
            ];

            const headerMaxLength = 100;
            const typesAlternation = allowedTypes.join('|');
            const headerRe = new RegExp(
              `^(${typesAlternation})(\\([^)]+\\))?(!)?:\\s.+$`
            );

            function validateHeader({ header, what }) {
              const errors = [];

              if (!header || typeof header !== 'string') {
                errors.push(`${what}: empty commit header`);
                return errors;
              }

              if (header.length > headerMaxLength) {
                errors.push(
                  `${what}: header too long (${header.length} > ${headerMaxLength}): "${header}"`
                );
              }

              if (header.endsWith('.')) {
                errors.push(`${what}: subject must not end with a period: "${header}"`);
              }

              if (!headerRe.test(header)) {
                errors.push(
                  `${what}: does not follow Conventional Commits: "${header}"`
                );
              }

              return errors;
            }

            let errors = [];

            if (context.eventName === 'pull_request') {
              const pull_number = context.payload.pull_request.number;
              const prTitle = context.payload.pull_request.title;
              errors = errors.concat(validateHeader({ header: prTitle, what: 'PR title' }));

              const commits = await github.paginate(github.rest.pulls.listCommits, {
                owner,
                repo,
                pull_number,
                per_page: 100,
              });

              for (const c of commits) {
                const sha = c.sha.slice(0, 7);
                const msg = c.commit && c.commit.message ? c.commit.message : '';
                const header = msg.split('\n')[0].trim();

                // Ignore merge commits created by GitHub or local merges
                if (/^Merge\s/i.test(header)) continue;

                const commitErrors = validateHeader({
                  header,
                  what: `Commit ${sha}`,
                });
                errors = errors.concat(commitErrors);
              }
            }

            if (context.eventName === 'push') {
              const commits = Array.isArray(context.payload.commits) ? context.payload.commits : [];
              for (const c of commits) {
                const sha = (c.id || '').slice(0, 7) || 'unknown';
                const msg = c.message || '';
                const header = msg.split('\n')[0].trim();

                // Ignore merge commits created by GitHub or local merges
                if (/^Merge\s/i.test(header)) continue;

                const commitErrors = validateHeader({
                  header,
                  what: `Commit ${sha}`,
                });
                errors = errors.concat(commitErrors);
              }
            }

            if (errors.length) {
              const help = [
                'Commit message convention: Conventional Commits',
                '',
                'Expected format:',
                '  <type>(<scope>)!: <subject>',
                '',
                `Allowed types: ${allowedTypes.join(', ')}`,
                '',
                'Examples:',
                '  feat(http): add checkStatus endpoint',
                '  fix(client): return PendingRequest from client builder',
                '  refactor(config)!: rename kpay defaults keys',
                '',
                'See CONTRIBUTING.md for details.',
              ].join('\n');

              core.setFailed(`${errors.join('\n')}\n\n${help}`);
            }
